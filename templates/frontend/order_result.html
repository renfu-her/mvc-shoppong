{% extends "base.html" %}

{% block title %}Order Result - MVC Shopping{% endblock %}

{% block content %}
<div class="breadcrumb-section">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('frontend.index') }}">Home</a></li>
                <li class="breadcrumb-item active" aria-current="page">Order Result</li>
            </ol>
        </nav>
    </div>
</div>

{% set txn = result_payload or {} %}
{% set rtn_code = txn.get('rtn_code') %}
{% set rtn_msg = txn.get('rtn_msg') or (order.payment_status == 'paid' and 'Payment completed successfully.') or 'Awaiting payment confirmation.' %}
{% set merchant_trade_no = txn.get('merchant_trade_no') or order.transaction_id %}
{% set trade_no = txn.get('trade_no') or order.ecpay_trade_no %}
{% set payment_type = txn.get('payment_type') or order.payment_method %}
{% set payment_date = txn.get('payment_date') %}
{% set trade_amt = txn.get('trade_amt') or ('%.2f'|format(order.total_amount)) %}

{% set is_paid = order.payment_status == 'paid' %}
{% set is_failed = order.payment_status == 'failed' %}
{% set is_pending = not is_paid and not is_failed %}

<div class="order-result-section py-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-9">
                <div class="card shadow-sm">
                    <div class="card-body p-5">
                        {% if is_paid %}
                        <div class="text-center mb-4">
                            <i class="fas fa-check-circle fa-5x text-success mb-3"></i>
                            <h2 class="text-success">Payment Successful</h2>
                            <p class="text-muted mb-0">Thank you! Your order is now being processed.</p>
                        </div>
                        {% elif is_failed %}
                        <div class="text-center mb-4">
                            <i class="fas fa-times-circle fa-5x text-danger mb-3"></i>
                            <h2 class="text-danger">Payment Failed</h2>
                            <p class="text-muted mb-0">{{ rtn_msg }}</p>
                        </div>
                        {% else %}
                        <div class="text-center mb-4">
                            <i class="fas fa-clock fa-5x text-warning mb-3"></i>
                            <h2 class="text-warning">Payment Pending</h2>
                            <p class="text-muted mb-0">{{ rtn_msg }}</p>
                        </div>
                        {% endif %}

                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="card h-100 border-0 bg-light">
                                    <div class="card-body">
                                        <h5 class="card-title">Order Summary</h5>
                                        <table class="table table-borderless align-middle mb-0">
                                            <tr>
                                                <td class="text-muted">Order Number</td>
                                                <td class="fw-semibold">{{ order.order_number }}</td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Created</td>
                                                <td>{{ order.created_at.strftime('%Y-%m-%d %H:%M') if order.created_at else '-' }}</td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Order Status</td>
                                                <td>
                                                    <span class="badge bg-{{ 'success' if is_paid else 'danger' if is_failed else 'warning text-dark' }}">
                                                        {{ order.status.title() if order.status else 'Pending' }}
                                                    </span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Payment Status</td>
                                                <td>
                                                    <span class="badge bg-{{ 'success' if is_paid else 'danger' if is_failed else 'warning text-dark' }}">
                                                        {{ order.get_payment_status_display() if order.get_payment_status_display else order.payment_status.title() }}
                                                    </span>
                                                </td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="card h-100 border-0 bg-light">
                                    <div class="card-body">
                                        <h5 class="card-title">Payment Information</h5>
                                        <table class="table table-borderless align-middle mb-0">
                                            <tr>
                                                <td class="text-muted">Merchant Trade No</td>
                                                <td>{{ merchant_trade_no or '-' }}</td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">ECPay Trade No</td>
                                                <td>{{ trade_no or '-' }}</td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Payment Method</td>
                                                <td>{{ payment_type or 'N/A' }}</td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Payment Time</td>
                                                <td>{{ payment_date or ('-' if not is_paid else order.updated_at.strftime('%Y-%m-%d %H:%M') if order.updated_at else '-') }}</td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Amount</td>
                                                <td class="fw-semibold text-primary">${{ trade_amt }}</td>
                                            </tr>
                                            {% if rtn_code %}
                                            <tr>
                                                <td class="text-muted">Gateway Status</td>
                                                <td>{{ rtn_code }} {{ txn.get('rtn_msg') or '' }}</td>
                                            </tr>
                                            {% endif %}
                                            {% if txn.get('TradeStatus') %}
                                            <tr>
                                                <td class="text-muted">Trade Status</td>
                                                <td>{{ txn.get('TradeStatus') }}</td>
                                            </tr>
                                            {% endif %}
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="order-items mt-4">
                            <h5 class="mb-3">Items in this Order</h5>
                            <div class="card border-0">
                                <div class="card-body p-0">
                                    <table class="table table-striped mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Product</th>
                                                <th class="text-center">Quantity</th>
                                                <th class="text-end">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for item in order.items %}
                                            <tr>
                                                <td>
                                                    <div class="fw-semibold">{{ item.product_name }}</div>
                                                    <div class="text-muted small">SKU: {{ item.product_sku }}</div>
                                                </td>
                                                <td class="text-center">{{ item.quantity }}</td>
                                                <td class="text-end">${{ '%.2f'|format(item.total_price) }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <div class="alert {{ 'alert-success' if is_paid else 'alert-warning' if is_pending else 'alert-danger' }}">
                                <i class="fas {{ 'fa-check-circle' if is_paid else 'fa-clock' if is_pending else 'fa-exclamation-triangle' }} me-2"></i>
                                {% if is_paid %}
                                    Your order will move to processing shortly. You can track its progress from your profile.
                                {% elif is_pending %}
                                    Payment confirmation may take a few minutes. If you have questions, please contact support with your order number.
                                {% else %}
                                    Payment was not completed. You may attempt checkout again or try another payment method.
                                {% endif %}
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <a class="btn btn-outline-secondary" href="{{ url_for('frontend.shop') }}">
                                <i class="fas fa-shopping-bag me-2"></i>Continue Shopping
                            </a>
                            <a class="btn btn-primary" href="{{ url_for('frontend.profile') }}#orders">
                                <i class="fas fa-receipt me-2"></i>View My Orders
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
.breadcrumb-section {
    background-color: #f8f9fa;
    padding: 1rem 0;
}

.order-result-section {
    background-color: #f8f9fa;
}

.success-icon, .pending-icon {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.wishlist-label {
    font-weight: 600;
}
</style>
{% endblock %}
